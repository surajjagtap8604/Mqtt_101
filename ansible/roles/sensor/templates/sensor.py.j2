import paho.mqtt.client as mqtt
import time
import random
import logging
import signal
import os

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

broker = os.getenv("MQTT_BROKER", "localhost")
port = int(os.getenv("MQTT_PORT", 1883))
topic = os.getenv("MQTT_TOPIC", "sensor/data")

client = mqtt.Client()

def signal_handler(signum, frame):
    logger.info("Stopping the sensor...")
    client.disconnect()
    exit(0)

signal.signal(signal.SIGTERM, signal_handler)
signal.signal(signal.SIGINT, signal_handler)

try:
    client.connect(broker, port, 60)
except Exception as e:
    logger.error(f"Connection failed: {e}")
    exit(1)

logger.info("Starting sensor data publication...")
while True:
    try:
        temperature = random.uniform(20.0, 30.0)
        client.publish(topic, str(temperature))
        logger.info(f"Published: {temperature:.2f}Â°C")
        time.sleep(5)
    except Exception as e:
        logger.error(f"Error in main loop: {e}")
        time.sleep(5)  # Wait before retrying